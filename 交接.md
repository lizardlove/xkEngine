## 引擎重构工作

[github](https://github.com/lizardlove/xkEngine)，fork一份到自己仓库，独立开发，后面更新不要合并到我的分支了。

主程序在`src/core`下，环境可自己单独配置，也可用我写好的，使用方法在`README`。

### 设计思路

`app`是打包入口文件

`Control`类作为全局的控制器，`Util`和`Scroll` ，`Resource`是必须的引入的组件。通用功能函数和外部属性，如浏览器，客户端的信息均保存在`Util`中。`Scroll`是保证各端对滑动事件的兼容，抽象的一层滑动控制器。`Resource`是全局资源控制，对图片和音乐资源进行预加载控制。

其余`Music`，`Animate`， `Gif`， `Swing`等均为动效组件，按需添加。初始化各动效实例流程在`Control`下`_computeAnimates` 中。

#### 数据处理

1. 初始化解析页面`DOM` 结构，根据`.Page`(漫画单页)部分累加计算全局绝对高度，并根据页面DPI对`img`大小进行适配放缩

2. 遍历`.page`收集绑定的动效配置信息和资源。

   动效配置信息按单条保存

   ```
   {'item':{'type':1,'speed':12,'delay':4,'animation':'ShowHi-21 1.25s linear 1 forwards'}}
   ```

   配置信息为`JSON`格式，绑定在`.page`下的各个`img`上，以`data-animal`标识。`data-animal`下可有多个`item`，一个`item`计算为一条动效配置，每条动效必须配置项为`type`，`speed`，`delay` 。可选配置项为`music`，`transform`，`opacity`，`animation`，`gif`，`swing`，每条动效，可选配置项只能取其一。

   资源信息按页保存，每个`.page`为一页，资源加载时按页进行加载。

3. 计算动效的全局绝对起始高度和结束高度。动效是依附于所属的`DOM`节点，因此各动效的起始高度的初始值为所属节点的全局高度，然后根据`type`和`delay`属性调整起始高度，`speed`在起始高度的基础上计算结束高度。以此，将各动效的控制从`DOM`节点上剥离，后续的动效控制仅根据滑动高度和动效的计算高度进行判断。

4. 数据处理基本完成，初始化页面活动对象和动画活动对象，准备进行漫画播放，页面按钮功能配置（音乐按钮，菜单按钮）。活动对象保存处于播放和预播放区域的页面和动画的索引，因为动画和页面的触发判断是分离的，分别根据各自的高度单独判断。所以有两个活动对象组。

5. 动画执行时，根据滑动控制器传入的滑动高度，对活动对象组进行更新，并对活动对象进行渲染

#### 动效渲染

动效配置序列化后，有自己的全局起始高度和结束高度，其差为存活长度。动效大致可分为两类，一类跟存活长度相关，需要根据滑动长度（滑动高度 - 起始高度）与存活长度的比例决定每一时刻属性值，如`opacity`，`transform`；一类跟存活长度无关，不需要根据高度计算和控制相关属性，如`animation`，`music`。

跟存活长度无关的，只需根据滑动高度和活动状态判断动效的开始和结束即可。而跟存活长度相关的，则需进行一次高度处理。将各高度（起始高度，结束高度，滑动高度）统一处理为长度（存活长度和滑动长度），然后转换为[0,1]比例值，再根据各动效的单位进行换算再赋值。

#### 资源加载

在数据处理时，资源已经按页分类保存，所以资源加载时也按页进行加载，目前资源有两类需求，图片和音乐，分别分装了单独的加载函数。每个资源有自己的加载控制属性`loaded`，每页还有单独的加载控制属性`status` 。当`status == pageResource.length`表示该页资源加载完成。对单个资源加载出错或超时进行控制，出错或超时500ms则重新加载。

## 怪奇后台-数据库

以后每周三导一次数据库数据给桃子。

使用方法

1. 启动 ![1551862684679](C:\Users\10261\AppData\Roaming\Typora\typora-user-images\1551862684679.png)

2. 选择MySQL连接![1551862730043](C:\Users\10261\AppData\Roaming\Typora\typora-user-images\1551862730043.png)

   

3. 具体登录参数，登录腾讯云账号获取云数据库信息
4. 怪奇后台数据库![1551862918860](C:\Users\10261\AppData\Roaming\Typora\typora-user-images\1551862918860.png)

5. 导出数据，选择excel格式![1551862950027](C:\Users\10261\AppData\Roaming\Typora\typora-user-images\1551862950027.png)

6. 日期格式显示乱码![1551863019873](C:\Users\10261\AppData\Roaming\Typora\typora-user-images\1551863019873.png)

   选中该列，顶部数据菜单里，选择分列![1551863077471](C:\Users\10261\AppData\Roaming\Typora\typora-user-images\1551863077471.png)

选择文本格式![1551863103204](C:\Users\10261\AppData\Roaming\Typora\typora-user-images\1551863103204.png)

即可消除乱码



### 云服务器相关

云服务器IP为118.89.17.105

腾讯云账号，服务器密码，数据库密码，ftp的登录，找瑞哥申请拿。我就不放在这了。